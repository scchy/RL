# åŸºäºä»·å€¼çš„æ¢ç´¢æ–¹æ³•æ€»ç»“

å¯¹äºä¸€ä¸ªæ™ºèƒ½ä½“è€Œè¨€éœ€è¦æƒè¡¡åˆ©ç”¨å’Œæ¢ç´¢ã€‚
åˆ©ç”¨å°±æ˜¯åˆ©ç”¨è¿‡å¾€çš„ç»éªŒï¼Œæ¢ç´¢å°±æ˜¯å¯¹ç¯å¢ƒè¿›è¡Œéšæœºçš„æ¢ç´¢

## 4.1 å„ç§æ¢ç´¢æ–¹æ³•

### 4.1.1 $\epsilon$-greedy æ–¹æ³•

ä¸€å®šçš„å‡ ç‡æ¢ç´¢

```python
    def _E_greedy_policy(self, s: int):
        if np.random.random() < self.explore_rate:
            return np.random.randint(len(self.Q[s]))
        if sum(self.Q[s]) != 0:
            return np.argmax(self.Q[s])
        return np.random.randint(len(self.Q[s]))
```

### 4.1.2 softmax

```python
    def __softmax(self, actions_v: np.ndarray):
        return np.exp(actions_v + 1e-3 ) / np.sum(np.exp(actions_v + 1e-3), axis=0)
    
    def _softmax_policy(self, s: int):
        return np.random.choice(range(len(self.Q[s])), size=1, p=self.__softmax(self.Q[s]))[0]
```

### 4.1.3 Thompson Sampling

è¿™éƒ¨åˆ†åšäº†ä¸€ç‚¹ä¿®æ”¹ï¼Œ äºŒé¡¹åˆ†å¸ƒç›´æ¥é‡‡ç”¨ å½“å‰sateçš„å„ä¸ªactionçš„value

```python
def _ThompsonSampling_policy(self, s: int):
    success_p = self.__softmax(self.Q[s])
    failed_p = 1 - success_p
    samples = np.random.beta(success_p, failed_p)
    return np.argmax(samples)
```

### 4.1.4 UCB

ucbå…¶å®å¯ä»¥ç†è§£ä¸ºï¼šæƒè¡¡-ç´¯è®¡åˆ°ç›®å‰çš„çŠ¶æ€ä¸‹çš„actionæ”¶ç›Š å’Œ actionçš„ä¸ç¡®å®šæ€§

- æ›´å¤šçš„æ¢ç´¢æ²¡æœ‰å°è¯•è¿‡çš„action

æ‰€ä»¥åšäº†ä¸€ç‚¹ä¿®æ”¹ï¼Œåªæœ‰å½“ç”¨åˆå§‹ç­–ç•¥Greedy æ¢ç´¢äº†æ‰€æœ‰stateä¹‹åæ‰å¼€å§‹UCB

```python
    def _ucb_policy(self, s):
        """ucbç­–ç•¥
        reference: 
        """
        self.ucb_cnt += 1
        if not self.ucb_cnt:
            self.__init_QTable()
            self.Q = self.Q + 1
        # å…ˆéªŒaction
        not_state_once = np.sum(self.ucb_sa_visit_cnt_arr > 1, axis=1).sum() < self.ucb_sa_visit_cnt_arr.shape[0]
        if not_state_once:
            a_final = self._ThompsonSampling_policy(s)
            self.ucb_sa_visit_cnt_arr[s, a_final] += 1
            return a_final

        self.ucb_print += 1
        if self.ucb_print == 1:
            print(f'UCB-Start {self.ucb_cnt}')
        b_t = self.__softmax(self.Q[s]) + self.__softmax(np.sqrt(2 * np.log(self.ucb_cnt) / self.ucb_sa_visit_cnt_arr[s]))
        a_final = np.argmax(b_t)
        self.ucb_sa_visit_cnt_arr[s, a_final] += 1
        return a_final
```

### å°ç»“

> [
rl-tutorials: æ¢ç´¢ç­–ç•¥ç ”ç©¶](https://github.com/johnjim0816/rl-tutorials/blob/master/notebooks/Q-learning/Q-learning%E6%8E%A2%E7%B4%A2%E7%AD%96%E7%95%A5%E7%A0%94%E7%A9%B6.ipynb)  
> [ç¬”è€…åˆç‰ˆ: æ¢ç´¢ç­–ç•¥ç ”ç©¶](https://github.com/scchy/RL/blob/main/joyRLTask/202210_task2/train.ipynb)

ğŸ“ åœ¨actionæœ‰é™çš„æƒ…å†µä¸‹ï¼Œä¸€èˆ¬epsilon_greedyæ¢ç´¢ç­–ç•¥æ›´åŠ çš„ç®€å•é«˜æ•ˆ, å¯ä»¥å°†epsilon_greedyæ¢ç´¢ç­–ç•¥ä½œä¸ºç¬¬ä¸€é€‰æ‹©ç­–ç•¥

ğŸ“ åœ¨epsilon_greedyæ¢ç´¢ç­–ç•¥è¡¨ç°ä¸ä½³çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç¬¬ä¸€ä¼˜å…ˆä½¿ç”¨softmaxæ¢ç´¢ç­–ç•¥

## 4.2 ä¸åŒæ¢ç´¢ç‡ç®€å•è¯•éªŒ

### 4.2.1 ç¯å¢ƒæ„å»º

å¯¹äºä¸€ä¸ªæ‘‡è‡‚æœºå™¨ï¼Œ æœ‰nä¸ªè‡‚ï¼Œä¸åŒè‡‚çš„ä¸­å¥–æ¦‚ç‡ä¸åŒï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸€å®šçš„æ‘‡è‡‚æ¬¡æ•°ä¹‹å†…è¾¾åˆ°æœ€é«˜çš„æ”¶ç›Šã€‚

```python
class RockerEnv:
    def __init__(self, rocker_reward_rate_list, total_do=30):
        self.rocker_reward_rate_list = rocker_reward_rate_list
        self.total_do = total_do
        self.cnt = 0
    
    def __len__(self):
        return len(self.rocker_reward_rate_list)

    def reset(self):
        self.cnt = 0
        
    def step(self, action):
        done = False
        if self.cnt >= self.total_do:
            done = True

        rocker_reward_rate = self.rocker_reward_rate_list[action]
        if rocker_reward_rate >= random.random():
            reward = 1
        else:
            reward = 0

        self.cnt += 1
        return reward, done
```

### 4.2.2 æ„å»ºæ¢ç´¢ä¸åˆ©ç”¨çš„æ™ºèƒ½ä½“

å½“ç”Ÿæˆçš„éšæœºæ•°å°äºæ¢ç´¢æ¦‚ç‡çš„æ—¶å€™è¿›è¡Œæ¢ç´¢ï¼ˆå³æ¢ç´¢è¦†ç›–çš„æ¦‚ç‡èŒƒå›´æ˜¯æ˜¯0-æ¢ç´¢æ¦‚ç‡ï¼‰ï¼Œåä¹‹åˆ™åˆ©ç”¨ä¹‹å‰çš„ç»éªŒï¼ŒåŠæ¯ä¸ªè‡‚çš„å¹³å‡æœŸæœ›ã€‚

```python

import numpy as np

class RockerAgent:
    def __init__(self, explore_rate=0.1):
        self.explore_rate = explore_rate
        self.V = []
        
    def policy(self):
        """æ™ºèƒ½ä½“çš„è¡ŒåŠ¨ç­–ç•¥"""
        rockers = range(len(self.V))
        if  random.random() < self.explore_rate:
            return random.choice(rockers)
        return np.argmax(self.V)

    def play(self, env):
        env.reset()
        done = False
        rocker_done_nums = [0] * len(env)
        self.V = [0] * len(env)
        rewards = []
        while not done:
            action = self.policy()
            reward, done = env.step(action)
            # æ›´æ–°ç»éªŒ
            new_avg = (self.V[action] + reward) / (rocker_done_nums[action] + 1)
            self.V[action] = new_avg
            rocker_done_nums[action] += 1
            rewards.append(reward)
        return rewards
```

### 4.2.3 æ™ºèƒ½ä½“è¡ŒåŠ¨

é’ˆå¯¹ä¸ç”¨ç­–ç•¥è¿›è¡Œå¤šæ­¥æ¢æµ‹ï¼ŒæŸ¥çœ‹ä¸åŒç­–ç•¥çš„æœ€ç»ˆå—ç›Šã€‚

```python

from collections import defaultdict
import matplotlib.pyplot as plt

rk_env = RockerEnv([0.1, 0.8, 0.1, 0.9, 0.1, 0.6, 0.1])
explore_rate_list = [0.0, 0.1, 0.2, 0.5, 0.8]
total_do_list = list(range(10, 310, 10))

rewards_record_dict = defaultdict(list)
for ep in explore_rate_list:
    ag = RockerAgent(explore_rate=ep)
    for td in total_do_list:
        tmp_rewards = []
        for _ in range(3):
            rk_env.total_do = td
            tmp_rewards.append(np.mean(ag.play(rk_env)))
        rewards_record_dict[f'explore_rate={ep}'].append(np.mean(tmp_rewards))


for key_ in rewards_record_dict:
    plt.plot(rewards_record_dict[key_], label=key_)

plt.xticks(range(len(total_do_list)), total_do_list)
plt.legend()
plt.show()
```

ä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºï¼Œåœ¨è¡ŒåŠ¨ä¸­å¢åŠ ä¸€ç‚¹æ¢ç´¢(0.1, 0.2)å¯ä»¥è¾¾åˆ°è¾ƒé«˜çš„æ”¶ç›Šï¼Œåœ¨å‰æœŸè¾ƒå°çš„æ¢ç´¢ç‡ä¼šæœ‰è¾ƒå¤§çš„æ³¢åŠ¨ï¼Œéšç€è¯•éªŒçš„æ¬¡æ•°å¢åŠ æ”¶ç›Šä¼šè¶‹äºç¨³å®šã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/d1159d2e9c1c4741951c516631ce196b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAU2NjX2h5,size_20,color_FFFFFF,t_70,g_se,x_16)

<b><font color=darkred>æ‰€ä»¥ï¼Œè¦åœ¨ä¸€ä¸ªé¢†åŸŸè¾¾åˆ°è¾ƒé«˜çš„æ°´å‡†ï¼Œéœ€è¦æˆ‘ä»¬å…·æœ‰ä¸€å®šçš„å†’é™©ç²¾ç¥ï¼Œä¸”æŒç»­ä¸æ–­çš„æŠ•å…¥</font></b>
